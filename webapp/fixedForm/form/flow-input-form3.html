<script type="text/javascript" src="widgets/loader/jgxLoader-min.js"></script>
<script type="text/javascript">
var xf_f_flow_view;   //流程查看
var UserSelection_new_inner_html='';
</script>

<input type="hidden" name="xf_f_formRecordId" value="$!{formMap.xf_f_formRecordId}" />
<input type="hidden" id="xf_f_formRecord_count" value="$!formMap.xf_f_formRecord_count"/>
<input id="xf_f_wages" name="xf_f_wages" type="hidden" value="" />
<table class="xf-table" cellspacing="0" cellpadding="0" width="100%" align="center" style="border-collapse: collapse;font-size: 12px;">
	<tbody>
		<tr id="topic">
			<td align="center" class="tasktd1" nowrap="">标题</td>
			<td class="tasktd2"><div class="xf-handler">
				<input id="xf_f_bt" type="text" readonly="readonly" name="topic" value="工资费用发放单据(2015-1)">&nbsp;</div></td>
			<td align="center" class="tasktd1" nowrap="">发放月份</td>
			<td class="tasktd2" colspan="3">
			<div class="xf-handler"><input id="xf_f_ffyf" type="text" name="month" readonly="readonly" value="2015-1"></div></td>
		</tr>
		<tr>
			<td colspan="6" style="padding: 0px;text-align: left; padding: 0px; border-style: hidden;">
				<table width="100%" border="1" cellspacing="0" cellpadding="0" class="xf-fee-table">
						<tr bgcolor="#dddddd" align="center" line_num="copy-number-0">
							<td width="4.5%" style="font-size: 12px,text-align:center">姓名</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">基本工资</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">考勤补贴</td>
							<td width="4%" style="font-size: 12px,text-align:center">养老(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">养老(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">住房(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">住房(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">医疗(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">医疗(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">工伤(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">工伤(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">失业(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">失业(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">生育(个人)</td>
							<td width="4%" style="font-size: 12px,text-align:center">生育(单位)</td>
							<td width="4%" style="font-size: 12px,text-align:center">所得税</td>
							<td width="4%" style="font-size: 12px,text-align:center">考勤扣款</td>
							<td width="4%" style="font-size: 12px,text-align:center">实发工资</td>
							<td width="10%" style="font-size: 12px,text-align:center">员工签名</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">&nbsp;&nbsp;&nbsp;&nbsp;备注</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">外勤费用</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">现金工资</td>
							<td width="4.5%" style="font-size: 12px,text-align:center">人力成本</td>
							<!-- <td width="4.5%" style="font-size: 12px,text-align:center">合计</td> -->
							<td width="2.5%" style="font-size: 12px,text-align:center">操作</td>
						</tr>
						
						<tr id="handleLine">
							<td colspan="24" align="right">
								<div class="xf-handler" style="text-align:right;margin-right:20px;">
								<!-- <a href="javascript:void(0);" class="easyui-linkbutton" onclick="export_Form()">test</a> -->
								<a href="javascript:void(0);" class="easyui-linkbutton copyWidget-add" iconCls="icon-add"></a>
								<a href="javascript:void(0);" class="easyui-linkbutton copyWidget-remove" iconCls="icon-remove"></a>
								</div>
							</td>
						</tr>
						<tr align="center" id="calLine">
							<td style="text-align: center">合计</td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="0"
								readonly="" resources=".fee_col0." name="payBase"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="1"
								readonly="" resources=".fee_col1." name="payAttendance"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="2"
								readonly="" resources=".fee_col2." name="pensionIndividual"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="3"
								readonly="" resources=".fee_col3." name="pensionUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="4"
								readonly="" resources=".fee_col4." name="housingIndividual"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="5"
								readonly="" resources=".fee_col5." name="housingUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="6"
								readonly="" resources=".fee_col6." name="medicalPersonal"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="7"
								readonly="" resources=".fee_col7." name="medicalUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="8"
								readonly="" resources=".fee_col8." name="injuryPersonal"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="9"
								readonly="" resources=".fee_col9." name="injuryUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="10"
								readonly="" resources=".fee_col10." name="unemploymentPersonal"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="11"
								readonly="" resources=".fee_col11." name="unemploymentUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="12"
								readonly="" resources=".fee_col12." name="fertilityPersonal"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="13"
								readonly="" resources=".fee_col13." name="fertilityUnits"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="14"
								readonly="" resources=".fee_col14." name="incomeTax"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="15"
								readonly="" resources=".fee_col15." name="attendanceChargeback"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="16"
								resources=".fee_col16." name="realWages"></div></td>
							<td><div class="xf-handler">&nbsp;</div></td>
							<td><div class="xf-handler">&nbsp;</div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="17"
								readonly="" resources=".fee_col19." name="fieldCost"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="18"
								readonly="" resources=".fee_col20." name="moneyWages"></div></td>
							<td><div class="xf-handler"><input class="total_row calculator" style="WIDTH: 40px" x="19"
								readonly="" resources=".fee_col21." name="payHrcost"></div></td>
							<td><!-- <div class="xf-handler"><input class="total_All calculator" style="WIDTH: 45px"
								resources=".total_row." name="xf_f_FeeAllTotal" id="xf_f_FeeAllTotal"></div> --></td>
							<td width="4%"></td>
						</tr>
				</table>
			</td>
		</tr>
	</tbody>
</table>
<div id="ui_mask" style="display:none" class="datagrid-mask"></div>
<div id="ui_mask_msg" style="display:none; left: 50%; height: 16px; margin-left: -85.5px; line-height: 16px;" class="datagrid-mask-msg">正在处理，请稍待。。。</div>
<script type="text/javascript">
$(function(){
	initData();
	initCloneArea();
	
	if(!xf_f_flow_view){
		$('.copyWidget-add').click(function(){
			var copyNum = $('#xf_f_formRecord_count').val();
			var newCopyNum = ++copyNum;
			
			addRow(newCopyNum);
			
			$('#xf_f_formRecord_count').val(newCopyNum);
		});
		$('.copyWidget-remove').click(function(){
			var copyNum = $('#xf_f_formRecord_count').val();
			if(copyNum==0){
				return false;
			}
			var targetTr = $('[line_num^="copy-number-"]:last');
			if(!targetTr){return false;}
			targetTr.remove();
			
			$('#xf_f_formRecord_count').val(--copyNum);
		});
	}else{
		$('#handleLine').remove();
	}
})

function initData(){
	var date = new Date();
	var str = date.getFullYear()+'-'+(date.getMonth());
	$('#xf_f_ffyf').val(str);
	$('#xf_f_bt').val('工资费用发放单据('+str+')');
}
/**
 * 外勤费用=人力成本-基本工资-考勤补贴-单位
 * 现金工资=基本工资-所有
 * 实发工资=基本工资-个人
 */
function changeNum(obj){
	//纵向合计
	var x=$(obj).attr('x');
	var y=$(obj).attr('y');
	var tar=$('input[class="total_row calculator"][x="'+x+'"]');
	var valStr='0';
	$('input[class!="total_row calculator"][x="'+x+'"]').each(function (){
		//var v_ = $(this).val().replace(/[^\d]/g,'0');
		v_ = (!v_)?'0':v_;
		var v_ = getVal($(this).val());
		valStr+='+'+v_;
	});
	tar.val(eval(valStr));

	//人力成本
	var payHrcost = getVal($(obj).closest('tr[id^="xf-g-"]').find('input[name="payHrcost"]').val());
	//基本工资
	var payBase = getVal($(obj).closest('tr[id^="xf-g-"]').find('input[name="payBase"]').val());
	//考勤补贴
	var payAttendance = getVal($(obj).closest('tr[id^="xf-g-"]').find('input[name="payAttendance"]').val());
	
	//外勤费用=人力成本-基本工资-考勤补贴-单位
	var valStr1=payHrcost+'-'+payBase+'-'+payAttendance;
	$(obj).closest('tr[id^="xf-g-"]').find('.U').each(function(){
		valStr1+='-'+getVal($(this).val());
	});
	$(obj).closest('tr[id^="xf-g-"]').find('input[name="fieldCost"]').val(eval(valStr1));

	//实发工资=基本工资-个人
	var valStr3=payBase+'';
	$(obj).closest('tr[id^="xf-g-"]').find('.I').each(function(){
		valStr3+='-'+getVal($(this).val());
	});
	$(obj).closest('tr[id^="xf-g-"]').find('input[name="realWages"]').val(eval(valStr3));

	//现金工资=人力成本-所有
	var valStr2=payHrcost+'';
	$(obj).closest('tr[id^="xf-g-"]').find('.A_').each(function(){
		valStr2+='-'+getVal($(this).val());
	});
	$(obj).closest('tr[id^="xf-g-"]').find('input[name="moneyWages"]').val(eval(valStr2));
}

function getVal(v){
	if(!v){
		return '0';
	}
	var v_ = v.replace(/[^\d]/g,'0');
	v_ = (!v_)?'0':v_;
	return v_;
}
function onpaste(){
	clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''));
}

function clearNoNum(obj)   
{   
	obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符  

	 obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是. 

	  obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.   

	obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");

}   

//初始化  可复制区域
function initCloneArea(){
	var datas;
	if ('$!{formMap.wage_staffs}' != ''){
		datas = eval('($!{formMap.wage_staffs})');
	}
	
	var copyNum = datas?datas.length:0;
	
	if ('$!{formMap.get("json")}' != ''){
		var wage = eval('($!{formMap.json})');
		datas = wage.detail;
		copyNum = datas.length;
		//填充统计行
		populateFields($('[id="calLine"]'),wage.total);
		//填充标题行
		populateFields($('[id="topic"]'),wage.total);
		
		//$('#xf_f_bt').val(wage.total.topic);
		//$('#xf_f_ffyf').val(wage.total.month)
	}
	
	if(copyNum>0){
		$('#xf_f_formRecord_count').val(copyNum-1);
		var count = parseInt(copyNum);
		for(var i=0;i<count;i++){
			addRow(i);
		}
		//循环工资详细行
		for(var i=0;i<count;i++){
			populateFields($('[line_num="copy-number-'+i+'"]'),datas[i]);
		}
	}
}

//添加行
function addRow(newCopyNum){
	var html = '<tr align="center" id="xf-g-'+newCopyNum+'" line_num="copy-number-'+newCopyNum+'">'+
	'<td><div class="xf-handler" style="display:none;"><input name="loginName" type="hidden" /></div><div class="xf-handler"><input style="width: 53px" name="realName"/></div></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="0" class="fee_row fee_col0" style="width: 40px" name="payBase"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="1" class="fee_row fee_col1" style="width: 40px" name="payAttendance"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="2" class="fee_row fee_col2 I A_" style="width: 40px" name="pensionIndividual"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="3" class="fee_row fee_col3 U A_" style="width: 40px" name="pensionUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="4" class="fee_row fee_col4 I A_" style="width: 40px" name="housingIndividual"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="5" class="fee_row fee_col5 U A_" style="width: 40px" name="housingUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="6" class="fee_row fee_col6 I A_" style="width: 40px" name="medicalPersonal"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="7" class="fee_row fee_col7 U A_" style="width: 40px" name="medicalUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="8" class="fee_row fee_col8 I A_" style="width: 40px" name="injuryPersonal"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="9" class="fee_row fee_col9 U A_" style="width: 40px" name="injuryUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="10" class="fee_row fee_col10 I A_" style="width: 40px" name="unemploymentPersonal"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="11" class="fee_row fee_col11 U A_" style="width: 40px" name="unemploymentUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="12" class="fee_row fee_col12 I A_" style="width: 40px" name="fertilityPersonal"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="13" class="fee_row fee_col13 U A_" style="width: 40px" name="fertilityUnits"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="14" class="fee_row fee_col14 A_" style="width: 40px" name="incomeTax"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="15" class="fee_row fee_col15" style="width: 40px" name="attendanceChargeback"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="16" class="fee_row fee_col16" style="width: 40px" name="realWages"></div></td>'+
	'<td><div class="xf-handler">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></td>'+
	'<td><div class="xf-handler"><input style="width: 60px" name="remark"/></div></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="17" class="fee_row fee_col19" style="width: 40px" name="fieldCost"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="18" class="fee_row fee_col20" style="width: 40px" name="moneyWages"></div></td>'+
	'<td><div class="xf-handler"><input onchange="changeNum(this);" onbeforepaste="onpaste()" y="'+newCopyNum+'" x="19" class="fee_row fee_col21" style="width: 40px" name="payHrcost"></div></td>'+
	'<td></td>'+
	'</tr>';

	var targetTr = $('[line_num^="copy-number-"]:last');
	$(targetTr).after(html);
}

//填充表单
function populateFields(line,data){
	//展示数据
	if(xf_f_flow_view && line){
		$(line).find('.xf-handler').each(function(){
			var field1 = $(this).find('input');
			var name = field1.attr('name'); 
			if(name){
				if(data[name]){
					$(this).html(data[name]);
				}else{
					$(this).html('');
				}
			}
		});
	}else{
		$(line).find('.xf-handler').each(function(){
			var field1 = $(this).find('input');
			var name = field1.attr('name');
			if(name){
				if(data[name]){
					$(field1).val(data[name]);
				}
			}
		});
	}
}

function export_Form(){
	var detail = '[';
	$('tr[id^="xf-g-"]').each(function (){
		var str = '{';
		$(this).find('.xf-handler').each(function(){
			var field1 = $(this).find('input');
			var name = field1.attr('name');
			if(name){
				var v_ = $(field1).val();
				if('realName'!=name && 'loginName'!=name && 'remark'!=name){
					v_=$(field1).val();//.replace(/[^\d]/g,'0');
					v_ = (v_=='')?'0':v_;
				}
				str+='"'+name+'":"'+v_+'",';
			}
		});
		detail+=str.substring(0,str.length-1)+'},';
	});
	detail = detail.substring(0,detail.length-1);
	detail +=']';
	
	var total = '{';
	$('#calLine').find('.xf-handler').each(function(){
		var field1 = $(this).find('input');
		var name = field1.attr('name');
		if(name){
			var v_ = $(field1).val();//.replace(/[^\d]/g,'0')
			total+='"'+name+'":"'+(v_==''?'0':v_)+'",';
		}
	});
	total+='"topic":"'+$('#xf_f_bt').val()+'",'+'"month":"'+$('#xf_f_ffyf').val()+'"';
	
	//total = total.substring(0,total.length-1);
	total +='}';
	
	var wages = '{"total":'+total+',"detail":'+detail+'}';
	
	$('#xf_f_wages').val(wages);
	
	//console.log('xf_f_wages:'+wages);
}
</script>