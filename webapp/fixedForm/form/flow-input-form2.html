<script type="text/javascript" src="widgets/loader/jgxLoader-min.js"></script>
<script type="text/javascript">
var xf_f_flow_view;   //流程查看
var UserSelection_new_inner_html='';
</script>
#if ($!formMap.xf_f_formRecord_count)
	#set ( $xf_f_formRecord_count = $!{formMap.xf_f_formRecord_count} )
#else 
	#set ( $xf_f_formRecord_count = 0 )
#end

#if ($!formMap.xf_f_fixed_fee)
	#set ( $xf_f_fixed_fee = $!{formMap.xf_f_fixed_fee} )
#else 
	#set ( $xf_f_fixed_fee = "15.00" )
#end
<form id="x_f_form">
<input type="hidden" name="xf_f_formRecordId" value="$!{formMap.xf_f_formRecordId}" />
<input type="hidden" name="xf_f_formRecord_count" id="xf_f_formRecord_count" value="$!xf_f_formRecord_count"/>
<input type="hidden" name="xf_f_fixed_fee" id="xf_f_fixed_fee" value="$!xf_f_fixed_fee"/>
<table class="xf-table" cellspacing="0" cellpadding="0" width="100%" align="center" style="border-collapse: collapse;font-size: 12px;">
	<tbody>
		<tr>
			<td>周报期间</td>
			<td class="tasktd2" width="20%">
				<div class="xf-handler">
				<select class="easyui-combobox" id="xf_f_xmqj" style="width:158px;" name="xf_f_xmqj" data-options="valueField:'name',textField:'name',editable:false">
				</select></div></td>
			<td width="12%" nowrap="" align="center">工时周报标题</td>
			<td width="20%">
				<div class="xf-handler">
					<input class="easyui-textbox" style="width:180px;" id="xf_f_gszbbt" name="xf_f_gszbbt" readonly=""/></div>
			</td>
			<td>专业级别</td>
			<td width="20%">
				<div class="xf-handler">
					<select class="easyui-combobox" id="xf_f_zyjb" style="width:158px;"
					data-options="method:'get',valueField:'name',textField:'name',editable:false"
					name="xf_f_zyjb">
					</select></div>
			</td>
		</tr>
		<tr>
			<td nowrap="" align="center">本周工作成果</td>
			<td colspan="5">
			<div class="xf-handler">
				<input class="easyui-textbox" id="xf_f_bzgzcg" name="xf_f_bzgzcg" data-options="multiline:true,required:true,validType:['length[0,200]']" style="width: 300px; height: 70px""></input>
				</div>
			</td>
		</tr>
		<tr>
			<td nowrap="" align="center">下周工作计划</td>
			<td colspan="5">
			<div class="xf-handler">
				<input class="easyui-textbox" id="xf_f_xzgzjh" name="xf_f_xzgzjh" data-options="multiline:true,required:true,validType:['length[0,200]']" style="width: 300px; height: 70px""></input>
				</div>
			</td>
		</tr>
		<tr>
			<td colspan="6" style="padding: 0px;text-align: left; padding: 0px; border-style: hidden;">
				<table width="100%" border="1" cellspacing="0" cellpadding="0" class="xf-fee-table">
						<tr bgcolor="#dddddd" align="center" line_num="copy-number-0">
							<td width="20%" style="font-size: 12px;text-align: center">工作事项</td>
							<td width="5%" style="font-size: 12px;text-align: center">周一</td>
							<td width="5%" style="font-size: 12px;text-align: center">周二</td>
							<td width="5%" style="font-size: 12px;text-align: center">周三</td>
							<td width="5%" style="font-size: 12px;text-align: center">周四</td>
							<td width="5%" style="font-size: 12px;text-align: center">周五</td>
							<td width="5%" style="font-size: 12px;text-align: center">周六</td>
							<td width="5%" style="font-size: 12px;text-align: center">周日</td>
							<td width="5%" style="font-size: 12px;text-align: center">合计</td>
							<td width="10%" style="font-size: 12px;text-align: center">工时费用</td>
							<td width="25%" style="font-size: 12px;text-align: center">客户简称</td>
							<td width="5%" style="font-size: 12px;text-align: center">删除</td>
						</tr>
						<tr>
							<td colspan="12" align="right">
								<div style="text-align:right">
								<a href="javascript:void(0);" class="easyui-linkbutton copyWidget-add" iconCls="icon-add"></a>
								<a href="javascript:void(0);" class="easyui-linkbutton copyWidget-remove" iconCls="icon-remove"></a>
								</div>
							</td>
						</tr>
						
						<tr align="center">
							<td style="text-align: center">合计</td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col0." name="xf_f_Day0Total" id="xf_f_Day0Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col1." name="xf_f_Day1Total" id="xf_f_Day1Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col2." name="xf_f_Day2Total" id="xf_f_Day2Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col3." name="xf_f_Day3Total" id="xf_f_Day3Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col4." name="xf_f_Day4Total" id="xf_f_Day4Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col5." name="xf_f_Day5Total" id="xf_f_Day5Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_row calculator" readonly="" style="WIDTH: 60px"
								data-options="min:0,precision:2" resources=".fee_col6." name="xf_f_Day6Total" id="xf_f_Day6Total"></div></td>
							<td><div class="xf-handler"><input class="easyui-numberbox total_All calculator" 
								data-options="min:0,precision:2" resources=".total_row."
								readonly="" style="WIDTH: 60px"
								name="xf_f_DayAllTotal" id="xf_f_DayAllTotal"></div></td>
							<td colspan="3"></td>
						</tr>
				</table>
			</td>
		</tr>
		<tr>
			<td colspan="6">
				<table class="xf-table" cellspacing="0" cellpadding="0" width="80%" align="center" style="border-collapse: collapse;font-size: 10px;">
					<tbody>
					<tr><td style="text-align: center" colspan="4"><b>单个项目一般基本工作分解及标准工时参考</b></td></tr>
					<tr><td width="25%" style="text-align: center"><b>角色安排</b></td>
						<td width="30%" style="text-align: center"><b>项目基本工作分解</b></td>
						<td width="25%" style="text-align: center"><b>预计工作量（次、份）</b></td>
						<td align="center"><b>单次或份的标准工时</b></td>
					</tr>
					<tr><td rowspan="5">项目经理（合伙人）</td>
						<td>项目承揽及其沟通</td>
						<td>3</td> <td>16</td></tr>
					<tr><td>客户持续沟通</td>
						<td>12</td>
						<td>8</td>
					</tr>
					<tr><td>项目专题会议</td>
						<td>6</td>
						<td>4</td>
					</tr>
					<tr><td>报告审阅</td>
						<td>30</td>
						<td>2</td>
					</tr>
					<tr><td>其他工作</td>
						<td>5</td>
						<td>4</td>
					</tr>
					<tr><td rowspan="7">项目主办</td>
						<td>项目建议书</td>
						<td>2</td>
						<td>16</td>
					</tr>
					<tr><td>项目协议</td>
						<td>1</td>
						<td>8</td>
					</tr>
					<tr><td>工作备忘录</td>
						<td>12</td>
						<td>8</td>
					</tr>
					<tr><td>项目专题会议</td>
						<td>6</td>
						<td>4</td>
					</tr>
					<tr><td>项目内部文件</td>
						<td>10</td>
						<td>2</td>
					</tr>
					<tr><td>行业研究报告</td>
						<td>2</td>
						<td>40</td>
					</tr>
					<tr><td>其他工作</td>
						<td>5</td>
						<td>4</td>
					</tr>
					<tr><td>辅助合伙人1</td>
						<td>项目专题会议或沟通</td>
						<td>6</td>
						<td>4</td>
					</tr>
					<tr><td>辅助合伙人2</td>
						<td>项目专题会议或沟通</td>
						<td>6</td>
						<td>4</td>
					</tr>
					<tr>
						<td>后台支持人员</td>
						<td>文件整理及支持</td>
						<td>240</td>
						<td>1</td>
					</tr>
				</table>
			</td>
		</tr>
	</tbody>
</table>
</form>
<script type="text/javascript">

$(function(){
	initCloneArea();
	
	if(!xf_f_flow_view){
		//设置默认值
		var value = $('#xf_f_fixed_fee').val();
		$('.fixed_fee').each(function (){
			$(this).textbox('setValue',value);
		});
		
		$('#xf_f_zyjb').combobox({url:'formTemplate!listDictionarys.do?dicKey=cfg_zhuanshujibie'});
		
		$('.copyWidget-add').click(function(){
			var copyNum = $('#xf_f_formRecord_count').val();
			var newCopyNum = ++copyNum;
			
			addRow(newCopyNum);
			
			$('#xf_f_formRecord_count').val(newCopyNum);
		});
		$('.copyWidget-remove').click(function(){
			var copyNum = $('#xf_f_formRecord_count').val();
			if(copyNum==0){
				return false;
			}
			var targetTr = $('[line_num^="copy-number-"]:last');
			if(!targetTr){return false;}
			targetTr.remove();
			
			$('#xf_f_formRecord_count').val(--copyNum);
		});
		
		// 大写控件 处理函数
		$('.upperDigit').each(function (){
			var upperDigit = $(this);
			var resources = $(this).attr('resources');
			if(!resources){return false;}
			var unique = resources.substring(1,resources.length-1);
			
			$('#xf_f_'+unique).textbox({
				onChange:function(){
					var upperValue = upDigit($(this).val());
					
					upperDigit.textbox('setValue',upperValue);
				}
			});
		})

		bindCalculateFun();
		
		bindHandleForProselection();
		
		loadXf_f_xmqj();
	}
})

function loadXf_f_xmqj(){
	var user = '$!staff.realName';
	$('#xf_f_xmqj').combobox({
	    editable:false,
	    valueField: 'label',
		textField: 'value',
		data: [{
			label: formatDayRange(-3),
			value: formatDayRange(-3)
		},{
			label: formatDayRange(-2),
			value: formatDayRange(-2)
		},{
			label: formatDayRange(-1),
			value: formatDayRange(-1)
		}],
		onSelect: function(record){
			$('#xf_f_gszbbt').textbox('setValue',(user+'-工时周报(')+record.label+')');
        }
	});
}
//格式化日期范围
function formatDayRange(swing){
	var oToday=new Date();
	var currentDay=oToday.getDay();
	if(currentDay==0){
		currentDay=7;
	}
	mondayTime=oToday.getTime()-(currentDay-1)*24*60*60*1000+(swing*7*24*60*60*1000);
	sundayTime=oToday.getTime()+(7-currentDay)*24*60*60*1000+(swing*7*24*60*60*1000);
	dateStart = new Date(mondayTime);
	dateEnd = new Date(sundayTime);
	
	var startMonth = (dateStart.getMonth()+1)+''; 	startMonth=startMonth.length==2?startMonth:('0'+startMonth);
	var startDay = dateStart.getDate()+''; 			startDay=startDay.length==2?startDay:('0'+startDay);
	
	var endMonth = (dateEnd.getMonth()+1)+''; 		endMonth=endMonth.length==2?endMonth:('0'+endMonth);
	var endDay = dateEnd.getDate()+''; 				endDay=endDay.length==2?endDay:('0'+endDay);
	
	var dayStart=dateStart.getFullYear()+'.'+startMonth+'.'+startDay;
	var dayEnd=dateEnd.getFullYear()+'.'+endMonth+'.'+endDay;
	
	return dayStart+'-'+dayEnd;
}

//初始化  可复制区域
function initCloneArea(){
	var copyNum = $('#xf_f_formRecord_count').val();
	var count = parseInt(copyNum)+1;
	for(var i=0;i<count;i++){
		addRow(i);
	}
}

//添加行
function addRow(newCopyNum){
	
	var html = '<tr align="center" id="xf-g-'+newCopyNum+'" line_num="copy-number-'+newCopyNum+'">'+
					'<td><div class="xf-handler"><input class="easyui-textbox" style="width: 200px" name="xf_f_workTopic~dy_clone'+newCopyNum+'"/></div></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col0" data-options="min:0" style="width: 60px" name="xf_f_Day1~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col1" data-options="min:0" style="width: 60px" name="xf_f_Day2~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col2" data-options="min:0" style="width: 60px" name="xf_f_Day3~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col3" data-options="min:0" style="width: 60px" name="xf_f_Day4~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col4" data-options="min:0" style="width: 60px" name="xf_f_Day5~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col5" data-options="min:0" style="width: 60px" name="xf_f_Day6~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox fee_row fee_col6" data-options="min:0" style="width: 60px" name="xf_f_Day7~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox total_single_row" data-options="min:0" readonly="" style="width: 60px" resources=".fee_row0." name="xf_f_Total~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><input class="easyui-numberbox" data-options="min:0,precision:2" style="width: 60px" readonly="" value="$!xf_f_fixed_fee" name="xf_f_Fee~dy_clone'+newCopyNum+'"></div></td>'+
					'<td><div class="xf-handler"><select style="width:135px;" class="easyui-combobox" '+
						'data-options="'+((!xf_f_flow_view)?'url:\'formTemplate!listDictionarys.do?dicKey=DIC_KHJC\',':'')+'method:\'get\',valueField:\'name\',textField:\'name\',panelHeight:\'auto\',editable:false" id="xf_f_cusCode~dy_clone'+newCopyNum+'" name="xf_f_cusCode~dy_clone'+newCopyNum+'"></select></div></td>'
					'<td></td>'+
				'</tr>';
				
	var targetTr = $('[line_num^="copy-number-"]:last');
	$(targetTr).after(html);
	
	jQuery.parser.parse($('[line_num="copy-number-'+newCopyNum+'"]'));
	if(!xf_f_flow_view){
		bindCalculateFun();
	}
}
//每行计算方法
function rowCalculate(){

	$('.total_single_row').each(function (){
		//#number1#+#number2#
		var id = this.id;
		var totalRowObj = $(this);
		var newResource = "0";
		
		$(this).closest('tr[id^="xf-g-"]').find('.fee_row').each(function(){
			var val = $(this).val();
			var newVal = (val!=null && val!=undefined && val!="")?val:"0";
			newResource=newResource+"+"+newVal;
		});
		
		var mode = eval(newResource);
		
		totalRowObj.textbox('setValue',mode);
	});
}

//绑定计算 函数
function bindCalculateFun(){
	//合计控件 处理函数
	$('.calculator').each(function (){
		//#number1#+#number2#
		var id = this.id;
		var totalObj = $(this);
		var resources = $(this).attr('resources');
		if(!resources){return false;}
		
		//初始化
		//totalObj.textbox('setValue',replacePattern(totalObj,resources));
		
		var regObj = new RegExp('.\\w+.','g');
		
		//#number1#+#number2#
		var res_array = resources.match(regObj);
		
		for(var key in res_array){
			var res = res_array[key];
			var regTmp = new RegExp(res);
			var className = res.substring(1,res.length-1);
			$('.'+className).textbox({
				onChange:function(){
					totalObj.textbox('setValue',replacePattern(totalObj,resources));
					rowCalculate();
				}
			});
		}
	})
}
//正则替换元素
function replacePattern(target,resources,keyAndvalue){
	if(!resources){return false;}
	var regObj = new RegExp('.\\w+.','g');
	var res_array = resources.match(regObj);
	//keyAndvalue 有值，证明为动态更新值，而不是初始化数据
	
	var newResource = "0";
	for(var key in res_array){
		var res = res_array[key];
		var regTmp = new RegExp(res);
		var className = res.substring(1,res.length-1);
		
		$('.'+className).each(function(){
			var val = $(this).val();
			var newVal = (val!=null && val!=undefined && val!="")?val:"0";
			//console.log(target.attr('textboxname')+',newVal:'+newVal+'\n'+'newResource:'+newResource);
			newResource=newResource+"+"+newVal;
			//console.log(target.attr('textboxname')+',newResource:'+newResource);
		});
	}
	var mode;
	if(target.hasClass('easyui-numberbox')){
		mode = eval(newResource);
	}
	
	return mode;
}
//转换金额为大写
function upDigit(n){ 
	var fraction = ['角', '分']; 
	var digit = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖']; 
	var unit = [ ['元', '万', '亿'], ['', '拾', '佰', '仟']  ]; 
	var head = n < 0? '欠': ''; 
	n = Math.abs(n); 
   
	var s = ''; 
   
	for (var i = 0; i < fraction.length; i++)  
	{ 
		s += (digit[Math.floor(n * 10 * Math.pow(10, i)) % 10] + fraction[i]).replace(/零./, ''); 
	} 
	s = s || '整'; 
	n = Math.floor(n); 
   
	for (var i = 0; i < unit[0].length && n > 0; i++)  
	{ 
		var p = ''; 
		for (var j = 0; j < unit[1].length && n > 0; j++)  
		{ 
			p = digit[n % 10] + unit[1][j] + p; 
			n = Math.floor(n / 10); 
		} 
		s = p.replace(/(零.)*零$/, '').replace(/^$/, '零')  + unit[0][i] + s; 
	} 
	return head + s.replace(/(零.)*零元/, '元').replace(/(零.)+/g, '零').replace(/^整$/, '零元整'); 
}
$(function (){
	//展示数据
	if ('$!{formMap.get("json")}' != '') {
		if(xf_f_flow_view){
			$('#toolDiv').remove();
			var data = eval('($!{formMap.json})');
			$('.xf-handler').each(function(){
				var field1 = $(this).find('input[class^="easyui-"][textboxname^="xf_f_"]');
				var field2 = $(this).find('select[class^="easyui-"][comboname^="xf_f_"]');
				var name = field1.attr('textboxname')?field1.attr('textboxname'):field2.attr('comboname'); 
				if(name){
					if(data[name]){
						$(this).html(data[name]);
					}else{
						$(this).html('');
					}
				}
			});
		}else{
			//$('#Form1').form('load',props);
			$('#Form1').form('load',eval('($!{formMap.json})'));
		}
	}
});
</script>
<!-- These JS Files should load at the end of the file -->
<script type="text/javascript" src="widgets/userselection/userselection-min.js"></script>
<script type="text/javascript" src="widgets/proselection/proselection-min.js"></script>